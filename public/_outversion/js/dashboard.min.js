var showmodechange=false;var velocity=0.2;var omega=0.4;var mainviewrnum=1;var robostate=4;var droped=0;var ismapping=false;var firsttrace=true;var sight_x=0;var sight_y=0;var ros=new ROSLIB.Ros({url:"ws://192.168.1.3:9090"});var cmdVel=new ROSLIB.Topic({ros:ros,name:"/cmd_vel",messageType:"geometry_msgs/Twist"});var twist=new ROSLIB.Message({linear:{x:0,y:0,z:0},angular:{x:0,y:0,z:0}});var chatter=new ROSLIB.Topic({ros:ros,name:"/chatter",messageType:"std_msgs/String"});var str_map=new ROSLIB.Message({data:"mapping"});var str_nav=new ROSLIB.Message({data:"nav"});var str_save=new ROSLIB.Message({data:"save"});var str_stop=new ROSLIB.Message({data:"stop"});var str_track=new ROSLIB.Message({data:"track"});var str_retrack=new ROSLIB.Message({data:"retrack"});var str_poweroff=new ROSLIB.Message({data:"shutdown"});var listener=new ROSLIB.Topic({ros:ros,name:"/odom",messageType:"nav_msgs/Odometry"});var listener_simplegoal=new ROSLIB.Topic({ros:ros,name:"/move_base_simple/goal",messageType:"geometry_msgs/PoseStamped"});var listener_robotpose=new ROSLIB.Topic({ros:ros,name:"/robot_pose",messageType:"geometry_msgs/Pose"});$(document).ready(function(){var d=$("#navtopheadtitle");var g=$(".nav-sidebar > li > a");var e=$(".nav-sidebar > .active > a");var v=$(".table-striped tbody > tr:nth-of-type(odd)");var Q=$(".table-hover tbody > tr");var J=$("#navdrop > li > a");var Z=$("#navdrop > .active > a");var l=$("#navbtn");var I=$("#navdrop");var f=$("#tb_vel");var X=$("#tb_dir");var D=$("#tb_xy");var K=$("#map_map");var A=$("#nav_map");var aa=$("#embtn");var j=$("#drop_motion");var w=$("#drop_map");var m=$("#drop_nav");var G=$("#drop_trace");var q=$("#drop_params");var i=$("#sidebar_motion");var L=$("#sidebar_map");var y=$("#sidebar_nav");var C=$("#sidebar_trace");var p=$("#sidebar_params");var c=$("#motion_moveforward");var V=$("#motion_moveback");var u=$("#motion_turnleft");var U=$("#motion_turnright");var n=$("#motion_softstop");var F=$("#motion_moveforwardcontainer");var W=$("#motion_movebackcontainer");var z=$("#motion_turnleftcontainer");var b=$("#motion_turnrightcontainer");var T=$("#motion_softstopcontainer");var P=$("#map_moveforward");var S=$("#map_moveback");var o=$("#map_turnleft");var k=$("#map_turnright");var h=$("#map_softstop");var E=$("#map_mapping");var M=$("#map_mapping_stop");var x=$("#poweroff");var H=$("#retrack");var B=$("#trace_pic");listener.subscribe(function(af){var ac=af.twist.twist.linear.x;var ah=af.twist.twist.angular.z;var ad=af.pose.pose.orientation.z;var ae=af.pose.pose.orientation.w;var ag=Math.atan2(ad,ae)/Math.PI*360;var ab=af.pose.pose.position.x;var ai=af.pose.pose.position.y;f.html("("+ac.toFixed(2)+", "+ah.toFixed(2)+")");X.html(ag.toFixed(2));D.html("("+ab.toFixed(2)+", "+ai.toFixed(2)+")")});listener_simplegoal.subscribe(function(ab){sight_x=ab.pose.position.x;sight_y=ab.pose.position.y});listener_robotpose.subscribe(function(ab){var ad=sight_x-ab.position.x;var ac=sight_y-ab.position.y;$("#trace_distx").html(ad.toFixed(2));$("#trace_disty").html(ac.toFixed(2))});ros.on("connection",function(){console.log("Connected to websocket server.")});ros.on("error",function(ab){console.log("Error connecting to websocket server: ",ab)});ros.on("close",function(){console.log("Connection to websocket server closed.")});if(ispc()){d.hover(function(){this.style.color="#f2473d"},function(){this.style.color="#e5483c"});g.hover(function(){this.style.backgroundColor="#ffdebe"},function(){if(document.activeElement!==this){this.style.backgroundColor="#fff0cd"}});g.focus(function(){g.css("background-color","#fff0cd");e.css("background-color","#ffa676");this.style.backgroundColor="#ffdebe"});e.hover(function(){this.style.color="#fffa08";this.style.backgroundColor="#ffa676"});e.focus(function(){g.css("background-color","#fff0cd");e.css("background-color","#ffa676")});n.hover(function(){this.style.color="#f90000"},function(){this.style.color="#dc0000"});h.hover(function(){this.style.color="#f90000"},function(){this.style.color="#dc0000"});u.hover(function(){this.style.color="#6cd56f"},function(){this.style.color="#4e9a50"});U.hover(function(){this.style.color="#6cd56f"},function(){this.style.color="#4e9a50"});o.hover(function(){this.style.color="#6cd56f"},function(){this.style.color="#4e9a50"});c.hover(function(){this.style.color="#3887c9"},function(){this.style.color="#3176b0"});V.hover(function(){this.style.color="#3887c9"},function(){this.style.color="#3176b0"});P.hover(function(){this.style.color="#3887c9"},function(){this.style.color="#3176b0"});S.hover(function(){this.style.color="#15e2cc"},function(){this.style.color="#13c8b4"});k.hover(function(){this.style.color="#ebe90e"},function(){this.style.color="#d9d70e"});Q.hover(function(){this.style.backgroundColor="#fbf2e8"},function(){this.style.backgroundColor="#FAFAFA"});v.hover(function(){this.style.backgroundColor="#fbf2e8"},function(){this.style.backgroundColor="#faf6f1"});J.hover(function(){this.style.backgroundColor="#ffdebe"},function(){if(document.activeElement!==this){this.style.backgroundColor="#fff0cd"
}});J.focus(function(){J.css("background-color","#fff0cd");Z.css("background-color","#ffa676");this.style.backgroundColor="#ffdebe"});Z.hover(function(){this.style.color="#fffa08";this.style.backgroundColor="#ffa676"});Z.focus(function(){J.css("background-color","#fff0cd");Z.css("background-color","#ffa676")});E.hover(function(){this.style.color="#f0960e"},function(){if(!ismapping){this.style.color="#d9880d"}});E.on("click",function(){ismapping=true;this.style.display="none";M.css("display","block");sendmode(1);robostate=1});M.hover(function(){this.style.color="#df28f4"},function(){if(ismapping){this.style.color="#b420c5"}});M.on("click",function(){ismapping=false;this.style.display="none";E.css("display","block");sendmode(3);robostate=4});aa.on("click",emergencystop);j.on("click",main_motion_clicked);w.on("click",main_map_clicked);m.on("click",main_nav_clicked);G.on("click",main_trace_clicked);q.on("click",main_params_clicked);i.on("click",main_motion_clicked);L.on("click",main_map_clicked);y.on("click",main_nav_clicked);C.on("click",main_trace_clicked);p.on("click",main_params_clicked);c.on("mousedown",function(){controltomove(velocity,0)});V.on("mousedown",function(){controltomove(-velocity,0)});u.on("mousedown",function(){controltomove(velocity,omega)});U.on("mousedown",function(){controltomove(velocity,-omega)});c.on("mouseup",softstop);V.on("mouseup",softstop);u.on("mouseup",softstop);U.on("mouseup",softstop);n.on("click",softstop);P.on("mousedown",function(){controltomove(velocity,0)});S.on("mousedown",function(){controltomove(-velocity,0)});o.on("mousedown",function(){controltomove(0,omega)});k.on("mousedown",function(){controltomove(0,-omega)});P.on("mouseup",softstop);S.on("mouseup",softstop);o.on("mouseup",softstop);k.on("mouseup",softstop);h.on("click",softstop);x.hover(function(){this.style.color="#ff1b0e";this.style.borderColor="#ff1b0e";this.style.cursor="pointer"},function(){this.style.color="#e5483c";this.style.borderColor="#e5483c";this.style.cursor="default"});x.on("click",powerdown);H.hover(function(){this.style.color="#f0960e";this.style.borderColor="#f0960e";this.style.cursor="pointer"},function(){this.style.color="#d9880d";this.style.borderColor="#d9880d";this.style.cursor="default"});H.on("click",function(){sendmode(6)});K.css({"text-align":"center","width":"100%","height":"430px","padding":"0","margin-left":"0","margin-right":"0"});var Y=new ROS2D.Viewer({divID:"map_map",width:430,height:430});var R=new NAV2D.OccupancyGridClientNav({ros:ros,rootObject:Y.scene,viewer:Y,serverName:"/move_base",withOrientation:true,continuous:true});A.css({"text-align":"center","width":"100%","height":"620px","padding":"0","margin-left":"0","margin-right":"0"});var O=new ROS2D.Viewer({divID:"nav_map",width:600,height:600});var a=new NAV2D.OccupancyGridClientNav({ros:ros,rootObject:O.scene,viewer:O,serverName:"/move_base",withOrientation:true,continuous:true});B.css({"text-align":"center","width":"100%","height":"480px","padding":"0","margin-left":"0","margin-right":"0"});$("#main_trace").css("padding-top","10px")}else{$("body").on("touchstart",function(){if(droped===1){I.css("display","none");droped=0}});aa.on("touchend",function(ab){ab.preventDefault();emergencystop()});l.on("touchstart",function(ab){ab.preventDefault();this.style.backgroundColor="#FFF0CD";J.css("background-color","#fff0cd");Z.css("background-color","#ffa676");if(mainviewrnum===2){w.css("background-color","#ffdebe")}else{if(mainviewrnum===3){m.css("background-color","#ffdebe")}else{if(mainviewrnum===4){G.css("background-color","#ffdebe")}else{if(mainviewrnum===5){q.css("background-color","#ffdebe")}}}}I.css("display","block")});l.on("touchend",function(ab){ab.preventDefault();this.style.backgroundColor="#FDF2E2";if(I.css("display")==="block"){droped=1}});j.on("touchstart",function(ab){ab.preventDefault();droped=2;this.style.color="#fffa08";this.style.backgroundColor="#ffa676"});j.on("touchend",function(ab){ab.preventDefault();droped=0;this.style.color="#fffa08";this.style.backgroundColor="#ffa676";main_motion_clicked();I.css("display","none")});w.on("touchstart",function(ab){ab.preventDefault();droped=2;this.style.backgroundColor="#ffdebe"});w.on("touchend",function(ab){ab.preventDefault();droped=0;this.style.backgroundColor="#fff0cd";main_map_clicked();I.css("display","none")});m.on("touchstart",function(ab){ab.preventDefault();droped=2;this.style.backgroundColor="#ffdebe"});m.on("touchend",function(ab){ab.preventDefault();droped=0;this.style.backgroundColor="#fff0cd";main_nav_clicked();I.css("display","none")});G.on("touchstart",function(ab){ab.preventDefault();droped=2;this.style.backgroundColor="#ffdebe"});G.on("touchend",function(ab){ab.preventDefault();droped=0;this.style.backgroundColor="#fff0cd";main_trace_clicked();I.css("display","none")});q.on("touchstart",function(ab){ab.preventDefault();droped=2;this.style.backgroundColor="#ffdebe"});q.on("touchend",function(ab){ab.preventDefault();droped=0;this.style.backgroundColor="#fff0cd";
main_params_clicked();I.css("display","none")});T.on("touchstart",function(ab){ab.preventDefault();n.css("color","#f90000");softstop()});T.on("touchend",function(ab){ab.preventDefault();n.css("color","#dc0000")});h.on("touchstart",function(ab){ab.preventDefault();this.style.color="#f90000";softstop()});h.on("touchend",function(ab){ab.preventDefault();this.style.color="#dc0000"});z.on("touchstart",function(ab){ab.preventDefault();u.css("color","#6cd56f");controltomove(velocity,omega)});z.on("touchend",function(ab){ab.preventDefault();u.css("color","#4e9a50");softstop()});b.on("touchstart",function(ab){ab.preventDefault();U.css("color","#6cd56f");controltomove(velocity,-omega)});b.on("touchend",function(ab){ab.preventDefault();U.css("color","#4e9a50");softstop()});o.on("touchstart",function(ab){ab.preventDefault();this.style.color="#6cd56f";controltomove(0,omega)});o.on("touchend",function(ab){ab.preventDefault();this.style.color="#4e9a50";softstop()});F.on("touchstart",function(ab){ab.preventDefault();c.css("color","#3887c9");controltomove(velocity,0)});F.on("touchend",function(ab){ab.preventDefault();c.css("color","#3176b0");softstop()});W.on("touchstart",function(ab){ab.preventDefault();V.css("color","#3887c9");controltomove(-velocity,0)});W.on("touchend",function(ab){ab.preventDefault();V.css("color","#3176b0");softstop()});P.on("touchstart",function(ab){ab.preventDefault();this.style.color="#3887c9";controltomove(velocity,0)});P.on("touchend",function(ab){ab.preventDefault();this.style.color="#3176b0";softstop()});S.on("touchstart",function(ab){ab.preventDefault();this.style.color="#15e2cc";controltomove(-velocity,0)});S.on("touchend",function(ab){ab.preventDefault();this.style.color="#13c8b4";softstop()});k.on("touchstart",function(ab){ab.preventDefault();this.style.color="#ebe90e";controltomove(0,-omega)});k.on("touchend",function(ab){ab.preventDefault();this.style.color="#d9d70e";softstop()});E.on("touchstart",function(ab){ab.preventDefault();this.style.color="#f0960e"});E.on("touchend",function(ab){ab.preventDefault();ismapping=true;this.style.color="#d9880d";this.style.display="none";M.css("display","block");sendmode(1);robostate=1});M.on("touchstart",function(ab){ab.preventDefault();this.style.color="#df28f4"});M.on("touchend",function(ab){ab.preventDefault();ismapping=false;this.style.color="#b420c5";this.style.display="none";E.css("display","block");sendmode(3);robostate=4});x.on("touchstart",function(ab){ab.preventDefault();this.style.color="#ff1b0e";this.style.borderColor="#ff1b0e"});x.on("touchend",function(ab){ab.preventDefault();this.style.color="#e5483c";this.style.borderColor="#e5483c";powerdown()});H.on("touchstart",function(ab){ab.preventDefault();this.style.color="#f0960e";this.style.borderColor="#f0960e"});H.on("touchend",function(ab){ab.preventDefault();this.style.color="#d9880d";this.style.borderColor="#d9880d";sendmode(6)});K.css({"text-align":"center","width":"100%","height":"270px","padding":"0","margin-left":"0","margin-right":"0"});var t=new ROS2D.Viewer({divID:"map_map",width:270,height:270});var s=new NAV2D.OccupancyGridClientNav({ros:ros,rootObject:t.scene,viewer:t,serverName:"/move_base",withOrientation:true,continuous:true});A.css({"text-align":"center","width":"100%","height":"280px","padding":"0","margin-left":"0","margin-right":"0"});var r=new ROS2D.Viewer({divID:"nav_map",width:280,height:280});var N=new NAV2D.OccupancyGridClientNav({ros:ros,rootObject:r.scene,viewer:r,serverName:"/move_base",withOrientation:true,continuous:true});B.css({"text-align":"center","width":"100%","height":"210px","padding":"0","margin-left":"0","margin-right":"0"});$("#nav_row2").css("display","block");$("#trace_row1").css("margin-top","0");$("#trace_row2").css("display","block");$("#trace_table").css("height","110px");$("#trace_row3").css("margin-top","0")}$("#setvel").slider({orientation:"horizontal",range:"min",min:10,max:120,value:20,slide:refreshSettingVel,change:refreshSettingVel});$("#setang").slider({orientation:"horizontal",range:"min",min:10,max:150,value:40,slide:refreshSettingAng,change:refreshSettingAng})});function main_motion_clicked(){$("#main_motion").css("display","block");$("#main_map").css("display","none");$("#main_nav").css("display","none");$("#main_trace").css("display","none");$("#main_params").css("display","none");mainviewrnum=1;sendmode(4);robostate=4}function main_map_clicked(){$("#main_motion").css("display","none");$("#main_map").css("display","block");$("#main_nav").css("display","none");$("#main_trace").css("display","none");$("#main_params").css("display","none");mainviewrnum=2;if(robostate===4){var a=confirm("请确认是否使用上次的地图...");if(a===true){sendmode(2);robostate=2}else{alert("请重新建图...");sendmode(4);robostate=4}}}function main_nav_clicked(){$("#main_motion").css("display","none");$("#main_map").css("display","none");$("#main_nav").css("display","block");$("#main_trace").css("display","none");$("#main_params").css("display","none");mainviewrnum=3;sendmode(2);robostate=2
}function main_trace_clicked(){if(robostate!==5){sendmode(5);robostate=5}$("#main_motion").css("display","none");$("#main_map").css("display","none");$("#main_nav").css("display","none");$("#main_params").css("display","none");if(firsttrace){pic_canvas=$("#trace_pic canvas");if(pic_canvas.length>0){pic_canvas.remove()}firsttrace=false;var a=$("#trace_pic");setTimeout(function(){$("#main_trace").css("display","block");mainviewrnum=4;if(ispc()){var b=new MJPEGCANVAS.Viewer({divID:"trace_pic",host:"192.168.1.3",port:"8181",width:640,height:480,topic:"/spencer/perception_internal/people_detection/rgbd_front_top/upper_body_detector/image"})}else{var c=new MJPEGCANVAS.Viewer({divID:"trace_pic",host:"192.168.1.3",port:"8181",width:280,height:210,topic:"/spencer/perception_internal/people_detection/rgbd_front_top/upper_body_detector/image"})}},2000)}else{$("#main_trace").css("display","block");mainviewrnum=4}}function main_params_clicked(){$("#main_motion").css("display","none");$("#main_map").css("display","none");$("#main_nav").css("display","none");$("#main_trace").css("display","none");$("#main_params").css("display","block");mainviewrnum=5}function controltomove(b,a){twist.linear.x=b;twist.angular.z=a;sendmotion()}function emergencystop(){sendmode(4);twist.linear.x=0;twist.angular.z=0;sendmotion()}function softstop(){twist.linear.x=0;twist.angular.z=0;sendmotion()}function sendmotion(){cmdVel.publish(twist)}function sendmode(a){switch(a){case 1:chatter.publish(str_map);firsttrace=true;break;case 2:chatter.publish(str_nav);firsttrace=true;break;case 3:chatter.publish(str_save);break;case 4:chatter.publish(str_stop);firsttrace=true;break;case 5:chatter.publish(str_track);if(showmodechange){alert("track")}break;case 6:chatter.publish(str_retrack);if(showmodechange){alert("retrack")}break;case -1:chatter.publish(str_poweroff);break;default:break}}function refreshSettingVel(){var a=$("#setvel").slider("value");velocity=a/100;$("#setvellabel").html(velocity);$("#patbvel").html(velocity)}function refreshSettingAng(){var a=$("#setang").slider("value");omega=a/100;$("#setanglabel").html(omega);$("#patbang").html(omega)}function powerdown(){sendmode(-1);robostate=-1;alert("power off")}function ispc(){var a=navigator.userAgent;var d=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"];var b=true;for(var c=0;c<d.length;c++){if(a.indexOf(d[c])>0){b=false;break}}return b};
